---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";

export const prerender = true;

const SITE = "https://www.upstrategia.fr";

// ✅ Static paths
export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => data.draft !== true);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// ✅ Post typé
const { post } = Astro.props as { post: CollectionEntry<"blog"> };

const { Content } = await render(post);

const title = `${post.data.title} - UpStrategia`;
const description =
  post.data.description ??
  "Article UpStrategia : CRM simple, relances propres (sans spam) et base de données exploitable pour TPE/PME B2B.";

// Date robuste
const rawDate = post.data.date;
const dateObj = rawDate instanceof Date ? rawDate : new Date(rawDate ?? "");
const hasValidDate = !Number.isNaN(dateObj.getTime());

const displayDate = hasValidDate
  ? dateObj.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" })
  : "";

const category = post.data.category?.trim();
const metaLine = [displayDate, category].filter(Boolean).join(" • ");

// Canonical
const canonicalUrl = post.data.canonical ?? `${SITE}/blog/${post.slug}`;

// Breadcrumb schema
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Accueil", item: `${SITE}/` },
    { "@type": "ListItem", position: 2, name: "Blog", item: `${SITE}/blog` },
    { "@type": "ListItem", position: 3, name: post.data.title, item: canonicalUrl },
  ],
};

// BlogPosting schema
const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description,
  mainEntityOfPage: { "@type": "WebPage", "@id": canonicalUrl },
  url: canonicalUrl,
  author: { "@type": "Person", name: post.data.author ?? "Carole Yché" },
  publisher: { "@type": "Organization", name: "UpStrategia", url: SITE },
  ...(hasValidDate ? { datePublished: dateObj.toISOString() } : {}),
  ...(hasValidDate ? { dateModified: dateObj.toISOString() } : {}),
};

// ✅ FAQ (optionnel)
const faqItems = post.data.faq ?? [];

const faqJsonLd =
  faqItems.length > 0
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqItems.map((x) => ({
          "@type": "Question",
          name: x.q,
          acceptedAnswer: { "@type": "Answer", text: x.a },
        })),
      }
    : null;
---

<Layout title={title} description={description} canonical={canonicalUrl}>
  <Fragment slot="head">
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} />

    {faqJsonLd && (
      <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />
    )}
  </Fragment>

  <main class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
    <article class="prose prose-slate max-w-none">
      <header class="not-prose">
        {metaLine && <p class="text-sm text-[var(--text-muted)]">{metaLine}</p>}

        <h1 class="mt-2 text-3xl sm:text-4xl font-semibold tracking-tight text-[var(--brand-blue)]">
          {post.data.title}
        </h1>

        <p class="mt-4 text-base sm:text-lg leading-relaxed text-[var(--text-muted)]">
          {post.data.description ?? description}
        </p>
      </header>

      <div class="mt-10">
        <Content />
      </div>

      {/* ✅ FAQ visible (si définie dans l’article) */}
      {(post.data.faq?.length ?? 0) > 0 && (
        <section class="not-prose mt-12">
          <h2 class="text-2xl font-semibold text-[var(--brand-blue)]">FAQ</h2>
          <div class="mt-6 space-y-3">
            {post.data.faq!.map((item) => (
              <details class="rounded-2xl border border-[var(--border-soft)] bg-white p-5 shadow-sm">
                <summary class="cursor-pointer list-none text-sm font-medium text-[var(--text-main)]">
                  {item.q}
                  <span class="float-right text-[var(--text-muted)] transition">⌄</span>
                </summary>
                <p class="mt-3 text-sm leading-relaxed text-[var(--text-muted)]">{item.a}</p>
              </details>
            ))}
          </div>
        </section>
      )}

      <hr class="my-10" />

      <!-- MAILLAGE INTERNE + CONVERSION (AUTO) -->
      <div class="not-prose rounded-3xl border border-[var(--border-soft)] bg-[var(--bg-soft)] p-8">
        <h2 class="text-xl font-semibold text-[var(--brand-blue)]">
          La prochaine étape simple (sans usine à gaz)
        </h2>
        <p class="mt-2 text-sm text-[var(--text-muted)]">
          Selon votre situation, voici la porte d’entrée la plus logique :
        </p>

        <div class="mt-6 grid gap-4 sm:grid-cols-3">
          <a
            href="/offres/crm-simple"
            class="group rounded-2xl border border-[var(--border-soft)] bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md"
          >
            <h3 class="text-sm font-semibold text-[var(--brand-blue)]">CRM simple</h3>
            <p class="mt-2 text-sm text-[var(--text-muted)]">
              Pour un suivi commercial clair (qui relancer, quand, et pourquoi).
            </p>
            <div class="mt-3 text-sm font-medium text-[var(--brand-copper)] group-hover:underline">
              Découvrir →
            </div>
          </a>

          <a
            href="/offres/relances-automatiques"
            class="group rounded-2xl border border-[var(--border-soft)] bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md"
          >
            <h3 class="text-sm font-semibold text-[var(--brand-blue)]">Relances automatiques</h3>
            <p class="mt-2 text-sm text-[var(--text-muted)]">
              Pour ne plus oublier de relancer, sans harceler ni spammer.
            </p>
            <div class="mt-3 text-sm font-medium text-[var(--brand-copper)] group-hover:underline">
              Découvrir →
            </div>
          </a>

          <a
            href="/offres/base-donnees-propre"
            class="group rounded-2xl border border-[var(--border-soft)] bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md"
          >
            <h3 class="text-sm font-semibold text-[var(--brand-blue)]">Base de données propre</h3>
            <p class="mt-2 text-sm text-[var(--text-muted)]">
              Pour rendre vos contacts exploitables (doublons, champs utiles, segmentation).
            </p>
            <div class="mt-3 text-sm font-medium text-[var(--brand-copper)] group-hover:underline">
              Découvrir →
            </div>
          </a>
        </div>

        <div class="mt-7 flex flex-wrap gap-3">
          <a
            href="/contact?from=blog&diagnostic=1"
            class="inline-flex items-center justify-center rounded-full bg-[var(--brand-copper)] px-6 py-3 text-sm font-medium hover:opacity-90 transition"
            style="color:#ffffff;"
          >
            Faire le point (15 min)
          </a>

          <a
            href="/offres"
            class="inline-flex items-center justify-center rounded-full border border-[var(--border-soft)] bg-white px-6 py-3 text-sm font-medium text-[var(--text-main)] hover:bg-black/5 transition"
          >
            Voir toutes les offres
          </a>
        </div>

        <p class="mt-4 text-xs text-[var(--text-muted)]">
          Basée à Rennes (Bretagne) — visio France entière. Réponse sous 48h (en général).
        </p>
      </div>
    </article>
  </main>
</Layout>
